#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

if [[ ! "$STRATEGY" =~ merge|rebase|squash ]]; then
  echo "Invalid strategy: must be merge, rebase, or squash" >&2
  exit 64
fi

: "${DRY_RUN:=0}"

: "${GH_ACTOR:=""}"
: "${GH_EVENT:=""}"
: "${GH_PR_ACTION:=""}"
: "${GH_PR_NUMBER:=""}"
: "${GH_PR_TITLE:=""}"

is_dependabot() {
  [[ "$GH_ACTOR" == 'dependabot[bot]' ]] && [[ "$GH_EVENT" == 'pull_request' ]]
}

exclude_by_title() {
  [[ -n "$EXCLUDE_TITLE_REGEX" ]] && [[ "$1" =~ $EXCLUDE_TITLE_REGEX ]]
}

gh_pr() {
  gh pr --repo "$GH_REPO" "$@"
}

tmp=$(mktemp -d)
trap 'rm -rf "$tmp"' EXIT

if is_dependabot && ! exclude_by_title "$GH_PR_TITLE"; then
  now_s=$(date +"%s")
  until_s=$((now_s + (QUARANTINE_DAYS * 24 * 60 * 60)))
  until=$(date -d "@$until_s" +"%Y-%m-%d")

  case "$GH_PR_ACTION" in
    opened)
      cat >"$tmp/message" <<EOM
:heavy_check_mark: If all status checks pass, and no other reviews are submitted, [mergeabot][] will merge this PR after $QUARANTINE_DAYS day(s), on $until.

As long as that's OK, no other action is necessary.

[mergeabot]: https://github.com/freckle/mergeabot-action
EOM
      ;;
    *)
      cat >"$tmp/message" <<EOM
:clock1: Resetting [mergeabot][] another $QUARANTINE_DAYS day(s) to $until.

[mergeabot]: https://github.com/freckle/mergeabot-action
EOM
      ;;
  esac

  gh pr comment "$GH_PR_NUMBER" --body-file "$tmp/message"
  exit 0
fi

now_s=$(date +"%s")
since_s=$((now_s - (QUARANTINE_DAYS * 24 * 60 * 60)))
since=$(date -d "@$since_s" +"%Y-%m-%d")

search="author:app/dependabot updated:<$since"
fields='number,title,author,updatedAt,reviewDecision'

gh_pr list --search "$search" --limit 1000 --json "$fields" --jq '.[]' |
  while IFS=$'\n' read -r ln; do
    number=$(jq --raw-output '.number' <<<"$ln")
    echo "$ln" >"$tmp/$number.json"
  done

found=0

for json in "$tmp"/*.json; do
  number=$(jq --raw-output '.number' "$json")
  title=$(jq --raw-output '.title' "$json")
  updatedAt=$(jq --raw-output '.updatedAt' "$json")
  reviewDecision=$(jq --raw-output '.reviewDecision' "$json")
  found=1

  printf '%s (#\e[34m%s\e[0m)\n' "$title" "$number"
  printf '  Last updated: \e[35m%s\e[0m\n' "$updatedAt"
  printf '  Current review decision: \e[35m%s\e[0m\n' "$reviewDecision"

  if exclude_by_title "$title"; then
    printf '  \e[1;37m=>\e[0m \e[33mSkip\e[0m (title matches exclude-title-regex)\n'
    continue
  fi

  case "$reviewDecision" in
    CHANGES_REQUESTED)
      printf '  \e[1;37m=>\e[0m \e[33mSkip\e[0m (changes requested)\n'
      ;;
    APPROVED)
      printf '  \e[1;37m=>\e[0m \e[32mEnable auto-merge\e[0m\n'
      if ((!DRY_RUN)); then
        gh_pr merge --auto "$number" --"$STRATEGY"
      fi
      ;;
    *)
      printf '  \e[1;37m=>\e[0m \e[32mApprove and enable auto-merge\e[0m\n'
      if ((!DRY_RUN)); then
        gh_pr review --approve "$number"
        gh_pr merge --auto "$number" --"$STRATEGY"
      fi
      ;;
  esac
done

if ((!found)); then
  echo "No Dependabot PRs found older than $since."
fi
