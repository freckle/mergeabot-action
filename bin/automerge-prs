#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

# Matches action defaults
: "${EXCLUDE_TITLE_REGEX:=""}"
: "${QUARANTINE_DAYS:=5}"
: "${STRATEGY:=rebase}"
: "${REMOVE_REVIEWERS:=true}"

# Except DRY_RUN=1 is better default if being run locally
: "${DRY_RUN:=1}"

# required: GH_REPO

: "${GH_ACTOR:=""}"
: "${GH_EVENT:=""}"
: "${GH_PR_ACTION:=""}"
: "${GH_PR_NUMBER:=""}"
: "${GH_PR_TITLE:=""}"
: "${GH_PR_HEAD_REF:=""}"

# Actions interface
: "${GITHUB_OUTPUT:=/dev/null}"

if [[ ! "$STRATEGY" =~ merge|rebase|squash ]]; then
  echo "Invalid strategy: must be merge, rebase, or squash" >&2
  exit 64
fi

is_dependabot() {
  [[ "$GH_ACTOR" == 'dependabot[bot]' ]] && [[ "$GH_EVENT" == 'pull_request' ]]
}

exclude_by_title() {
  [[ -n "$EXCLUDE_TITLE_REGEX" ]] && [[ "$1" =~ $EXCLUDE_TITLE_REGEX ]]
}

is_workflows_update() {
  [[ "$1" =~ ^dependabot/github_actions/.* ]]
}

gh_pr() {
  gh pr --repo "$GH_REPO" "$@"
}

tmp=$(mktemp -d)
trap 'rm -rf "$tmp"' EXIT

if is_dependabot && ! exclude_by_title "$GH_PR_TITLE" && ! is_workflows_update "$GH_PR_HEAD_REF"; then
  if ((QUARANTINE_DAYS <= 0)); then
    when_message="the next time it runs"
  else
    now_s=$(date +"%s")
    until_s=$((now_s + (QUARANTINE_DAYS * 24 * 60 * 60)))
    until=$(date -d "@$until_s" +"%Y-%m-%d")
    when_message="after $QUARANTINE_DAYS day(s), on $until"
  fi

  case "$GH_PR_ACTION" in
    opened)
      if [[ "$REMOVE_REVIEWERS" == 'true' ]]; then
        read -r users_json < <(gh api "repos/$GH_REPO/pulls/$GH_PR_NUMBER/requested_reviewers" | jq '[.users[].login]' -c)
        read -r teams_json < <(gh api "repos/$GH_REPO/pulls/$GH_PR_NUMBER/requested_reviewers" | jq '[.teams[].name]' -c)

        if [[ "$users_json" != '[]' ]] || [[ "$teams_json" != '[]' ]]; then
          echo "Removing requested reviewers"
          echo "{\"reviewers\":$users_json,\"team_reviewers\":$teams_json}" |
            gh api -X DELETE --input - "repos/$GH_REPO/pulls/$GH_PR_NUMBER/requested_reviewers"
        fi
      fi

      cat >"$tmp/message" <<EOM
:heavy_check_mark: If all status checks pass, and no other reviews are submitted, [mergeabot][] will merge this PR $when_message.

As long as that's OK, no other action is necessary.

[mergeabot]: https://github.com/freckle/mergeabot-action
EOM
      ;;
    *)
      cat >"$tmp/message" <<EOM
:clock1: PR was updated. [Mergeabot][] will now merge this PR $when_message.

[mergeabot]: https://github.com/freckle/mergeabot-action
EOM
      ;;
  esac

  gh pr comment "$GH_PR_NUMBER" --body-file "$tmp/message"
  exit 0
fi

read -r defaultBranch < \
  <(gh repo view "$GH_REPO" --json defaultBranchRef --jq '.defaultBranchRef.name')

gh api \
  "/repos/$GH_REPO/branches/$defaultBranch/protection" \
  --jq '.required_status_checks.contexts[]' |
  sort >"$tmp/required-statuses.txt"

now_s=$(date +"%s")
since_s=$((now_s - (QUARANTINE_DAYS * 24 * 60 * 60)))
since=$(date -d "@$since_s" +"%Y-%m-%d")

search="author:app/dependabot updated:<$since"
fields='number,title,headRefName,author,updatedAt,reviewDecision,statusCheckRollup'

gh_pr list --search "$search" --limit 1000 --json "$fields" --jq '.[]' |
  while IFS=$'\n' read -r ln; do
    number=$(jq --raw-output '.number' <<<"$ln")
    echo "$ln" >"$tmp/$number.json"
  done

found=0
failed=()

for json in "$tmp"/*.json; do
  number=$(jq --raw-output '.number' "$json")
  title=$(jq --raw-output '.title' "$json")
  branch=$(jq --raw-output '.headRefName' "$json")
  updatedAt=$(jq --raw-output '.updatedAt' "$json")
  reviewDecision=$(jq --raw-output '.reviewDecision' "$json")
  found=1

  printf '%s (#\e[34m%s\e[0m)\n' "$title" "$number"
  printf '  Last updated: \e[35m%s\e[0m\n' "$updatedAt"
  printf '  Current review decision: \e[35m%s\e[0m\n' "$reviewDecision"

  if exclude_by_title "$title"; then
    printf '  \e[1;37m=>\e[0m \e[33mSkip\e[0m (title matches exclude-title-regex)\n'
    continue
  fi

  if is_workflows_update "$branch"; then
    printf '  \e[1;37m=>\e[0m \e[33mSkip\e[0m (PR updates worflows)\n'
    continue
  fi

  jq --raw-output '.statusCheckRollup[] | select(.conclusion=="FAILURE") | .name' "$json" | sort >"$tmp/$number-failed-statuses.txt"
  comm -12 "$tmp/required-statuses.txt" "$tmp/$number-failed-statuses.txt" >"$tmp/$number-required-failed-statuses.txt"

  read -r failedStatuses < <(paste -sd ' ' "$tmp/$number-required-failed-statuses.txt")
  read -r failedStatusesCount < <(wc -l <"$tmp/$number-required-failed-statuses.txt")

  if ((failedStatusesCount == 1)); then
    statusesHave='status has'
  else
    statusesHave='statuses have'
  fi

  if [[ -n "$failedStatuses" ]]; then
    failed+=("$number")
    printf '  \e[1;31m!!\e[0m %d required %s failed: \e[35m%s\e[0m\n' \
      "$failedStatusesCount" \
      "$statusesHave" \
      "$failedStatuses"
    continue
  fi

  case "$reviewDecision" in
    CHANGES_REQUESTED)
      printf '  \e[1;37m=>\e[0m \e[33mSkip\e[0m (changes requested)\n'
      ;;
    APPROVED)
      printf '  \e[1;37m=>\e[0m \e[32mEnable auto-merge\e[0m\n'
      if ((!DRY_RUN)); then
        gh_pr merge --auto "$number" --"$STRATEGY"
      fi
      ;;
    *)
      printf '  \e[1;37m=>\e[0m \e[32mApprove and enable auto-merge\e[0m\n'
      if ((!DRY_RUN)); then
        gh_pr review --approve "$number"
        gh_pr merge --auto "$number" --"$STRATEGY"
      fi
      ;;
  esac
done

if ((${#failed})); then
  echo "Warning: the following PRs cannot be auto-merged:"
  echo "failed=true" >>"$GITHUB_OUTPUT"
  echo "failed-urls<<EOM" >>"$GITHUB_OUTPUT"
  for number in "${failed[@]}"; do
    printf 'https://github.com/%s/pull/%s\n' "$GH_REPO" "$number"
  done | tee -a "$GITHUB_OUTPUT"
  echo "EOM" >>"$GITHUB_OUTPUT"

fi

if ((!found)); then
  echo "No Dependabot PRs found older than $since."
fi
